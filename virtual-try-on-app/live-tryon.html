<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Virtual Try-On - Meesho</title>
    <link rel="stylesheet" href="tryon-styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <style>
        .live-tryon-container {
            display: flex;
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .video-panel {
            flex: 2;
            background: #000;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }
        
        .video-container {
            width: 100%;
            height: 600px;
            position: relative;
            background: #111;
            border-radius: 15px;
            overflow: hidden;
        }
        
        .live-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .video-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
        }
        
        .controls-panel {
            flex: 1;
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .measurement-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        
        .measurement-item {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        
        .measurement-item:last-child {
            border-bottom: none;
        }
        
        .tryon-section {
            margin-top: 20px;
        }
        
        .clothing-upload {
            border: 2px dashed #ddd;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .clothing-upload:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }
        
        .clothing-preview {
            max-width: 100%;
            max-height: 150px;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-secondary {
            background: #f1f3f4;
            color: #333;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .calibration-controls {
            background: #f8f9ff;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }
        
        .calibration-slider {
            width: 100%;
            margin: 10px 0;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
            font-size: 14px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #28a745;
            animation: pulse 2s infinite;
        }
        
        .status-dot.error {
            background: #dc3545;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .result-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .result-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            text-align: center;
        }
        
        .notifications {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }
        
        .notification {
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <button class="back-btn" onclick="window.history.back()">
                <i class="fas fa-arrow-left"></i>
            </button>
            <h1>📹 Live Virtual Try-On</h1>
            <div class="status-indicator">
                <div class="status-dot" id="connectionStatus"></div>
                <span id="connectionText">Connecting...</span>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="live-tryon-container">
        <!-- Video Panel -->
        <div class="video-panel">
            <div class="video-container">
                <video id="liveVideo" class="live-video" autoplay muted></video>
                <canvas id="videoOverlay" class="video-overlay"></canvas>
            </div>
            
            <div class="video-controls" style="padding: 15px; background: rgba(0,0,0,0.8); color: white;">
                <button class="btn btn-primary" id="startCameraBtn" onclick="startCamera()">
                    <i class="fas fa-video"></i> Start Camera
                </button>
                <button class="btn btn-secondary" id="stopCameraBtn" onclick="stopCamera()" disabled>
                    <i class="fas fa-video-slash"></i> Stop Camera
                </button>
                <button class="btn btn-secondary" onclick="capturePhoto()">
                    <i class="fas fa-camera"></i> Capture
                </button>
            </div>
        </div>

        <!-- Controls Panel -->
        <div class="controls-panel">
            <!-- Camera Mode Clothing Display -->
            <div id="cameraClothingDisplay" style="display: none; margin-bottom: 20px;">
                <h3><i class="fas fa-tshirt"></i> Selected Clothing</h3>
                <div id="cameraClothingContainer" style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                    <img id="cameraClothingImage" style="max-width: 100%; max-height: 120px; border-radius: 8px; margin-bottom: 10px;">
                    <div id="cameraClothingName" style="font-weight: 600; color: #28a745;"></div>
                    <small style="color: #666;">Ready for virtual try-on</small>
                </div>
            </div>

            <!-- Try-On Result Display for Camera Mode -->
            <div id="cameraResultDisplay" style="display: none; margin-bottom: 20px;">
                <h3><i class="fas fa-magic"></i> Try-On Result</h3>
                <div style="text-align: center; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; color: white;">
                    <img id="cameraResultImage" style="max-width: 100%; max-height: 200px; border-radius: 8px; margin-bottom: 10px;">
                    <div class="action-buttons" style="justify-content: center;">
                        <button class="btn" onclick="saveCameraResult()" style="background: white; color: #333; margin: 5px;">
                            <i class="fas fa-download"></i> Save
                        </button>
                        <button class="btn" onclick="shareCameraResult()" style="background: white; color: #333; margin: 5px;">
                            <i class="fas fa-share"></i> Share
                        </button>
                        <button class="btn" onclick="tryAgain()" style="background: white; color: #333; margin: 5px;">
                            <i class="fas fa-redo"></i> Try Again
                        </button>
                    </div>
                </div>
            </div>

            <!-- Real-time Measurements -->
            <div class="measurement-display">
                <h3><i class="fas fa-ruler-combined"></i> Live Measurements</h3>
                <div id="measurementData">
                    <div class="measurement-item">
                        <span>Shoulders:</span>
                        <span id="shoulderMeasurement">-- cm</span>
                    </div>
                    <div class="measurement-item">
                        <span>Waist:</span>
                        <span id="waistMeasurement">-- cm</span>
                    </div>
                    <div class="measurement-item">
                        <span>Confidence:</span>
                        <span id="confidenceLevel">--%</span>
                    </div>
                    <div class="measurement-item">
                        <span>Resolution:</span>
                        <span id="resolutionInfo">--</span>
                    </div>
                </div>
            </div>

            <!-- Calibration Controls -->
            <div class="calibration-controls">
                <h4><i class="fas fa-sliders-h"></i> Calibration</h4>
                <label for="multiplierSlider">Measurement Multiplier:</label>
                <input type="range" id="multiplierSlider" class="calibration-slider" 
                       min="0.1" max="3.0" step="0.1" value="1.0" 
                       onchange="updateMultiplier(this.value)">
                <span id="multiplierValue">1.0x</span>
                
                <div class="action-buttons" style="grid-template-columns: 1fr;">
                    <button class="btn btn-secondary" onclick="resetCalibration()">
                        <i class="fas fa-undo"></i> Reset Calibration
                    </button>
                </div>
            </div>

            <!-- Virtual Try-On Section -->
            <div class="tryon-section">
                <h3><i class="fas fa-tshirt"></i> Virtual Try-On</h3>
                <div class="clothing-upload" onclick="document.getElementById('clothingInput').click()">
                    <input type="file" id="clothingInput" accept="image/*" style="display: none;" onchange="handleClothingUpload(event)">
                    <i class="fas fa-upload" style="font-size: 24px; color: #667eea;"></i>
                    <p>Upload Clothing Image</p>
                    <small>JPG, PNG, WEBP supported</small>
                    <img id="clothingPreview" class="clothing-preview" style="display: none;">
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="tryOnBtn" onclick="performTryOn()" disabled>
                        <i class="fas fa-magic"></i> Try On
                    </button>
                    <button class="btn btn-secondary" onclick="openClothingCatalog()">
                        <i class="fas fa-th-large"></i> Catalog
                    </button>
                </div>
                
                <div class="action-buttons" style="margin-top: 10px;">
                    <button class="btn btn-secondary" id="clearClothingBtn" onclick="clearCurrentClothing()" style="display: none;">
                        <i class="fas fa-times"></i> Clear Clothing
                    </button>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="action-buttons" style="margin-top: 20px;">
                <button class="btn btn-secondary" onclick="toggleZInfo()">
                    <i class="fas fa-info-circle"></i> Toggle Info
                </button>
                <button class="btn btn-secondary" onclick="downloadMeasurements()">
                    <i class="fas fa-download"></i> Save Data
                </button>
            </div>

            <!-- Debug Panel (hidden by default) -->
            <div id="debugPanel" style="display: none; margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px; border: 1px solid #dee2e6;">
                <h4><i class="fas fa-bug"></i> Debug Info</h4>
                <div style="font-family: monospace; font-size: 12px;">
                    <div><strong>Camera:</strong> <span id="debugCamera">Not started</span></div>
                    <div><strong>Clothing:</strong> <span id="debugClothing">Not selected</span></div>
                    <div><strong>API Status:</strong> <span id="debugAPI">Unknown</span></div>
                    <div><strong>Button Clicks:</strong> <span id="debugClickCount">0</span></div>
                    <div><strong>Last Call:</strong> <span id="debugLastCall">None</span></div>
                </div>
                <button class="btn btn-secondary" onclick="testAPICall()" style="margin-top: 10px; font-size: 12px;">
                    <i class="fas fa-flask"></i> Test API Call
                </button>
                <button class="btn btn-secondary" onclick="simpleAPITest()" style="margin-top: 5px; font-size: 12px;">
                    <i class="fas fa-heartbeat"></i> Basic API Test
                </button>
            </div>

            <div class="action-buttons" style="margin-top: 10px;">
                <button class="btn btn-secondary" onclick="toggleDebug()" style="font-size: 12px;">
                    <i class="fas fa-code"></i> Debug
                </button>
            </div>
        </div>
    </div>

    <!-- Result Modal -->
    <div id="tryOnResultModal" class="result-modal">
        <div class="result-content">
            <h3><i class="fas fa-magic"></i> Virtual Try-On Result</h3>
            <img id="tryOnResultImage" style="max-width: 100%; height: auto; border-radius: 10px; margin: 20px 0;">
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="saveTryOnResult()">
                    <i class="fas fa-download"></i> Save
                </button>
                <button class="btn btn-secondary" onclick="closeTryOnResult()">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        </div>
    </div>

    <!-- Notifications -->
    <div id="notifications" class="notifications"></div>

    <script>
        // API Configuration
        const API_BASE = 'http://localhost:8000';
        let socket = null;
        let mediaStream = null;
        let currentClothingFile = null;
        let tryOnClickCount = 0;

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        async function initializeApp() {
            console.log('🎬 Live Try-On initialized');
            
            // Check if coming from camera mode
            const urlParams = new URLSearchParams(window.location.search);
            const fromCamera = urlParams.get('from') === 'camera' || window.location.href.includes('mode=camera');
            
            // Check for pre-selected clothing from studio
            loadPreSelectedClothing(fromCamera);
            
            // Check API health
            const apiHealthy = await checkAPIHealth();
            if (apiHealthy) {
                connectWebSocket();
            }
        }

        function loadPreSelectedClothing(fromCamera = false) {
            const clothingData = localStorage.getItem('liveClothingImage');
            const clothingName = localStorage.getItem('liveClothingName');
            const clothingType = localStorage.getItem('liveClothingType');
            const timestamp = localStorage.getItem('liveClothingTimestamp');
            
            // If coming from camera mode, hide upload section and make it clothing-focused
            if (fromCamera) {
                const uploadSection = document.querySelector('.tryon-section');
                if (uploadSection) {
                    uploadSection.style.display = 'none';
                }
                
                // Update header to show it's camera mode
                const header = document.querySelector('.header h1');
                if (header) {
                    header.innerHTML = '📹 Live Virtual Try-On - Camera Mode';
                }
            }
            
            if (clothingData && clothingName) {
                console.log('🎨 Pre-selected clothing detected from studio');
                console.log('📋 Clothing type:', clothingType);
                
                // Check if clothing is recent (less than 1 hour old)
                const now = Date.now();
                const clothingAge = timestamp ? now - parseInt(timestamp) : Infinity;
                const maxAge = 60 * 60 * 1000; // 1 hour
                
                if (clothingAge < maxAge) {
                    
                    if (clothingType === 'file') {
                        // Handle uploaded file (data URL) - can be used for API
                        console.log('📁 Loading uploaded file from studio');
                        
                        fetch(clothingData)
                            .then(res => res.blob())
                            .then(blob => {
                                // Create a File object for API usage
                                currentClothingFile = new File([blob], 'studio-clothing.jpg', { type: 'image/jpeg' });
                                
                                // Display the clothing preview
                                const preview = document.getElementById('clothingPreview');
                                preview.src = clothingData;
                                preview.style.display = 'block';
                                
                                displayLoadedClothing(clothingData, clothingName, fromCamera, true);
                                
                                showNotification('✨ Uploaded clothing loaded from studio!', 'success');
                                console.log('✅ Uploaded clothing loaded successfully');
                            })
                            .catch(error => {
                                console.error('Failed to load uploaded clothing:', error);
                                showNotification('⚠️ Failed to load uploaded clothing', 'warning');
                            });
                            
                    } else {
                        // Handle preset image (URL) - display only, no API support
                        console.log('🎨 Loading preset image from studio');
                        
                        // Display the clothing preview
                        const preview = document.getElementById('clothingPreview');
                        preview.src = clothingData;
                        preview.style.display = 'block';
                        
                        // No file object for presets - API calls won't work
                        currentClothingFile = null;
                        
                        displayLoadedClothing(clothingData, clothingName + ' (Preset - Display Only)', fromCamera, false);
                        
                        showNotification('🎨 Preset clothing loaded (API not available)', 'info');
                        console.log('✅ Preset clothing loaded for display');
                    }
                } else {
                    console.log('⏰ Pre-selected clothing expired, clearing...');
                    clearStoredClothing();
                }
            } else {
                console.log('📂 No pre-selected clothing found');
            }
        }

        function clearStoredClothing() {
            localStorage.removeItem('liveClothingImage');
            localStorage.removeItem('liveClothingName');
            localStorage.removeItem('liveClothingTimestamp');
            localStorage.removeItem('liveClothingType');
        }

        // Helper function to display loaded clothing in UI
        function displayLoadedClothing(clothingData, clothingName, fromCamera, apiSupported) {
            // For camera mode, show clothing in controls panel, otherwise in upload area
            if (fromCamera) {
                createClothingDisplayForCamera(clothingData, clothingName);
            } else {
                // Update upload area to show it's from studio
                const uploadArea = document.getElementById('clothingUploadArea');
                const placeholder = uploadArea.querySelector('.upload-placeholder');
                if (placeholder) {
                    const statusIcon = apiSupported ? 'fas fa-check-circle' : 'fas fa-info-circle';
                    const statusColor = apiSupported ? '#28a745' : '#ffc107';
                    const statusText = apiSupported ? 'Loaded from Virtual Try-On Studio' : 'Display Only - Upload files for AI try-on';
                    
                    placeholder.innerHTML = `
                        <i class="${statusIcon}" style="color: ${statusColor}; font-size: 24px;"></i>
                        <p style="color: ${statusColor}; font-weight: 600;">${clothingName}</p>
                        <small>${statusText}</small>
                    `;
                    uploadArea.style.borderColor = statusColor;
                    uploadArea.style.backgroundColor = apiSupported ? '#f8fff9' : '#fffbf0';
                }
            }
            
            // Enable/disable try-on button and update status
            if (fromCamera) {
                document.getElementById('clearClothingBtn').style.display = 'block';
            } else {
                document.getElementById('tryOnBtn').disabled = !apiSupported;
                document.getElementById('clearClothingBtn').style.display = 'block';
            }
            
            // Update try-on button status based on current state
            updateTryOnButtonStatus();
        }

        function createClothingDisplayForCamera(clothingData, clothingName) {
            // Show camera clothing display
            const cameraDisplay = document.getElementById('cameraClothingDisplay');
            if (cameraDisplay) {
                cameraDisplay.style.display = 'block';
                
                const clothingImage = document.getElementById('cameraClothingImage');
                const clothingNameEl = document.getElementById('cameraClothingName');
                
                if (clothingImage) clothingImage.src = clothingData;
                if (clothingNameEl) clothingNameEl.textContent = clothingName;
            }
        }

        function clearCurrentClothing() {
            // Clear stored clothing
            clearStoredClothing();
            
            // Clear current clothing file
            currentClothingFile = null;
            
            // Hide clothing preview
            const preview = document.getElementById('clothingPreview');
            preview.style.display = 'none';
            preview.src = '';
            
            // Reset upload area
            const uploadArea = document.getElementById('clothingUploadArea');
            const placeholder = uploadArea.querySelector('.upload-placeholder');
            if (placeholder) {
                placeholder.innerHTML = `
                    <i class="fas fa-upload" style="font-size: 24px; color: #667eea;"></i>
                    <p>Upload Clothing Image</p>
                    <small>JPG, PNG, WEBP supported</small>
                `;
                uploadArea.style.borderColor = '#ddd';
                uploadArea.style.backgroundColor = '';
            }
            
            // Hide clear button
            document.getElementById('clearClothingBtn').style.display = 'none';
            
            // Clear file input
            document.getElementById('clothingInput').value = '';
            
            // Update try-on button status
            updateTryOnButtonStatus();
            
            showNotification('🧹 Clothing cleared', 'info');
        }

        async function checkAPIHealth() {
            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();
                
                if (data.status === 'healthy') {
                    updateConnectionStatus(true, 'API Connected');
                    showNotification('✅ Streaming API is ready!', 'success');
                    return true;
                }
            } catch (error) {
                console.error('API health check failed:', error);
                updateConnectionStatus(false, 'API Disconnected');
                showNotification('❌ Cannot connect to streaming API', 'error');
                return false;
            }
        }

        function connectWebSocket() {
            socket = io(API_BASE);
            
            socket.on('connect', () => {
                updateConnectionStatus(true, 'Live Connected');
                showNotification('🔗 Live streaming connected!', 'success');
            });
            
            socket.on('disconnect', () => {
                updateConnectionStatus(false, 'Disconnected');
                showNotification('🔌 Connection lost', 'warning');
            });
            
            socket.on('processed_frame', (data) => {
                updateVideoDisplay(data.frame);
                updateMeasurements(data.measurements);
                console.log('Received measurements:', data.measurements);
            });
            
            socket.on('status', (data) => {
                showNotification(data.message, 'info');
            });
            
            socket.on('error', (data) => {
                showNotification(data.message, 'error');
            });
        }

        async function startCamera() {
            try {
                mediaStream = await navigator.mediaDevices.getUserMedia({
                    video: { width: 1280, height: 720 }
                });
                
                const video = document.getElementById('liveVideo');
                video.srcObject = mediaStream;
                
                // Set display calibration
                video.onloadedmetadata = () => {
                    const rect = video.getBoundingClientRect();
                    if (socket) {
                        socket.emit('display_calibration', {
                            video_width: video.videoWidth,
                            video_height: video.videoHeight,
                            display_width: rect.width,
                            display_height: rect.height,
                            screen_width: window.screen.width,
                            screen_height: window.screen.height,
                            device_pixel_ratio: window.devicePixelRatio || 1
                        });
                    }
                    
                    // Update try-on button status after camera is ready
                    updateTryOnButtonStatus();
                };
                
                // Start sending frames
                sendFrames();
                
                document.getElementById('startCameraBtn').disabled = true;
                document.getElementById('stopCameraBtn').disabled = false;
                
                showNotification('📹 Camera started!', 'success');
                
                // Show camera ready status after a short delay
                setTimeout(() => {
                    updateTryOnButtonStatus();
                    showNotification('✅ Camera ready for virtual try-on!', 'success');
                }, 2000);
                
            } catch (error) {
                console.error('Camera access failed:', error);
                showNotification('❌ Camera access denied', 'error');
            }
        }

        function sendFrames() {
            if (!socket || !mediaStream) return;
            
            const video = document.getElementById('liveVideo');
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            function captureFrame() {
                if (!mediaStream || !video.videoWidth) {
                    setTimeout(captureFrame, 100);
                    return;
                }
                
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                ctx.drawImage(video, 0, 0);
                
                const imageData = canvas.toDataURL('image/jpeg', 0.8);
                // Remove the data:image/jpeg;base64, prefix
                const base64Data = imageData.split(',')[1];
                socket.emit('process_frame', { frame: base64Data });
                
                setTimeout(captureFrame, 100); // 10 FPS
            }
            
            captureFrame();
        }

        function stopCamera() {
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }
            
            document.getElementById('startCameraBtn').disabled = false;
            document.getElementById('stopCameraBtn').disabled = true;
            
            // Update try-on button status
            updateTryOnButtonStatus();
            
            showNotification('📹 Camera stopped', 'info');
        }

        function updateTryOnButtonStatus() {
            const tryOnBtn = document.getElementById('tryOnBtn');
            if (!tryOnBtn) return;
            
            const hasClothing = currentClothingFile !== null;
            const hasCameraRunning = mediaStream !== null;
            
            if (hasClothing && hasCameraRunning) {
                // Everything ready for try-on
                tryOnBtn.disabled = false;
                tryOnBtn.innerHTML = '<i class="fas fa-magic"></i> Try On Outfit';
                tryOnBtn.style.background = 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';
                tryOnBtn.title = 'Ready for virtual try-on!';
            } else if (hasClothing && !hasCameraRunning) {
                // Need camera
                tryOnBtn.disabled = true;
                tryOnBtn.innerHTML = '<i class="fas fa-video"></i> Start Camera First';
                tryOnBtn.style.background = '#6c757d';
                tryOnBtn.title = 'Please start the camera to enable virtual try-on';
            } else if (!hasClothing && hasCameraRunning) {
                // Need clothing
                tryOnBtn.disabled = true;
                tryOnBtn.innerHTML = '<i class="fas fa-tshirt"></i> Select Clothing First';
                tryOnBtn.style.background = '#6c757d';
                tryOnBtn.title = 'Please select clothing to enable virtual try-on';
            } else {
                // Need both
                tryOnBtn.disabled = true;
                tryOnBtn.innerHTML = '<i class="fas fa-magic"></i> Try On';
                tryOnBtn.style.background = '#6c757d';
                tryOnBtn.title = 'Please select clothing and start camera';
            }
        }

        function updateVideoDisplay(frameBase64) {
            if (frameBase64) {
                // Display processed frame with pose detection overlay
                const video = document.getElementById('liveVideo');
                const overlay = document.getElementById('videoOverlay');
                
                if (overlay) {
                    const ctx = overlay.getContext('2d');
                    const img = new Image();
                    img.onload = () => {
                        overlay.width = video.videoWidth || img.width;
                        overlay.height = video.videoHeight || img.height;
                        ctx.clearRect(0, 0, overlay.width, overlay.height);
                        ctx.drawImage(img, 0, 0, overlay.width, overlay.height);
                    };
                    img.src = 'data:image/jpeg;base64,' + frameBase64;
                }
            }
        }

        function updateMeasurements(measurements) {
            console.log('updateMeasurements called with:', measurements);
            
            if (!measurements) {
                console.log('No measurements data received');
                return;
            }
            
            // Update shoulder measurement
            const shoulderElement = document.getElementById('shoulderMeasurement');
            if (shoulderElement) {
                shoulderElement.textContent = 
                    measurements.shoulder_cm ? `${measurements.shoulder_cm.toFixed(1)} cm` : '-- cm';
            }
            
            // Update waist measurement
            const waistElement = document.getElementById('waistMeasurement');
            if (waistElement) {
                waistElement.textContent = 
                    measurements.waist_cm ? `${measurements.waist_cm.toFixed(1)} cm` : '-- cm';
            }
            
            // Update confidence level
            const confidenceElement = document.getElementById('confidenceLevel');
            if (confidenceElement) {
                confidenceElement.textContent = 
                    measurements.confidence ? `${(measurements.confidence * 100).toFixed(0)}%` : '--%';
            }
            
            // Update resolution info
            const resolutionElement = document.getElementById('resolutionInfo');
            if (resolutionElement && measurements.resolution) {
                resolutionElement.textContent = 
                    `${measurements.resolution.width}x${measurements.resolution.height}`;
            }
            
            console.log('Measurements updated successfully');
        }

        function updateConnectionStatus(connected, text) {
            const statusDot = document.getElementById('connectionStatus');
            const statusText = document.getElementById('connectionText');
            
            statusDot.className = connected ? 'status-dot' : 'status-dot error';
            statusText.textContent = text;
        }

        function handleClothingUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Clear any stored clothing from studio
            clearStoredClothing();
            
            currentClothingFile = file;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const preview = document.getElementById('clothingPreview');
                preview.src = e.target.result;
                preview.style.display = 'block';
                
                // Reset upload area styling
                const uploadArea = document.getElementById('clothingUploadArea');
                const placeholder = uploadArea.querySelector('.upload-placeholder');
                if (placeholder) {
                    placeholder.innerHTML = `
                        <i class="fas fa-upload" style="font-size: 24px; color: #667eea;"></i>
                        <p>New clothing selected</p>
                        <small>JPG, PNG, WEBP supported</small>
                    `;
                    uploadArea.style.borderColor = '#667eea';
                    uploadArea.style.backgroundColor = '';
                }
                
                document.getElementById('clearClothingBtn').style.display = 'block';
                showNotification('👕 New clothing image loaded!', 'success');
                
                // Update try-on button status
                updateTryOnButtonStatus();
            };
            reader.readAsDataURL(file);
        }

        async function performTryOn() {
            tryOnClickCount++;
            document.getElementById('debugClickCount').textContent = tryOnClickCount;
            
            console.log('🎯 performTryOn() called! (Click #' + tryOnClickCount + ')');
            showNotification('🎯 Try-On button clicked! (#' + tryOnClickCount + ')', 'info');
            
            if (!currentClothingFile) {
                console.error('❌ No clothing file');
                showNotification('❌ Please upload a clothing image first', 'error');
                return;
            }
            
            // Check if camera is running (required for virtual try-on API)
            if (!mediaStream) {
                console.error('❌ No media stream');
                showNotification('📹 Please start the camera first for virtual try-on', 'warning');
                return;
            }
            
            console.log('✅ Pre-flight checks passed, proceeding with API call...');
            
            // Check if we're in camera mode
            const urlParams = new URLSearchParams(window.location.search);
            const fromCamera = urlParams.get('from') === 'camera' || window.location.href.includes('mode=camera');
            
            try {
                showNotification('🎭 Processing virtual try-on...', 'info');
                console.log('🔄 Starting virtual try-on API call...');
                
                // Prepare form data with clothing image
                const formData = new FormData();
                formData.append('clothing_image', currentClothingFile);
                
                // Log detailed debug info
                console.log('📤 API Call Details:');
                console.log('  URL:', `${API_BASE}/virtual-tryon`);
                console.log('  Method: POST');
                console.log('  Clothing file:', currentClothingFile.name, currentClothingFile.type, currentClothingFile.size, 'bytes');
                console.log('  FormData contents:', Array.from(formData.entries()));
                
                // Add debug notification
                showNotification(`📤 Calling API: ${API_BASE}/virtual-tryon`, 'info');
                
                // Call the virtual try-on API with additional debugging
                console.log('🚀 Making fetch request...');
                const response = await fetch(`${API_BASE}/virtual-tryon`, {
                    method: 'POST',
                    body: formData,
                    // Don't set Content-Type header - let browser set it with boundary for multipart/form-data
                });
                
                console.log('📥 Response received:');
                console.log('  Status:', response.status);
                console.log('  StatusText:', response.statusText);
                console.log('  Headers:', Object.fromEntries(response.headers.entries()));
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('📋 API Response:', result);
                    
                    if (result.success) {
                        console.log('✅ Virtual try-on successful, displaying result...');
                        
                        // Always use the prominent modal display for better visibility
                        showTryOnResult('data:image/jpeg;base64,' + result.result_image_base64);
                        showNotification('✨ Virtual try-on complete!', 'success');
                    } else {
                        console.error('❌ API returned error:', result.error);
                        throw new Error(result.error || 'Try-on failed');
                    }
                } else {
                    // Handle HTTP errors
                    const errorText = await response.text();
                    console.error('❌ HTTP Error:', response.status, errorText);
                    
                    if (response.status === 400) {
                        if (errorText.includes('No video frame available')) {
                            throw new Error('Camera not ready. Please ensure camera is running and try again.');
                        }
                        throw new Error('Invalid request. Please check your inputs.');
                    } else if (response.status === 500) {
                        throw new Error('Server error. Please try again later.');
                    } else {
                        throw new Error(`API Error ${response.status}: ${errorText}`);
                    }
                }
                
            } catch (error) {
                console.error('❌ Virtual try-on failed:', error);
                console.error('Error stack:', error.stack);
                
                // Update debug info
                document.getElementById('debugLastCall').textContent = `Error: ${error.message}`;
                
                showNotification('❌ Try-on failed: ' + error.message, 'error');
                
                // Show helpful troubleshooting info
                if (error.message.includes('Camera not ready')) {
                    setTimeout(() => {
                        showNotification('💡 Make sure camera is started and showing live video', 'info');
                    }, 2000);
                } else if (error.message.includes('fetch')) {
                    setTimeout(() => {
                        showNotification('💡 Check network connection and API server', 'info');
                    }, 2000);
                }
            }
        }

        function showTryOnResult(imageBase64) {
            const resultImage = document.getElementById('tryOnResultImage');
            resultImage.src = imageBase64;
            
            document.getElementById('tryOnResultModal').style.display = 'flex';
        }

        function showCameraResult(imageBase64) {
            // Show result in camera mode display
            const cameraResultDisplay = document.getElementById('cameraResultDisplay');
            const cameraResultImage = document.getElementById('cameraResultImage');
            
            if (cameraResultDisplay && cameraResultImage) {
                cameraResultImage.src = 'data:image/jpeg;base64,' + imageBase64;
                cameraResultDisplay.style.display = 'block';
                
                // Scroll to result
                cameraResultDisplay.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                
                // Store result for save/share functions
                window.currentCameraResult = 'data:image/jpeg;base64,' + imageBase64;
            }
        }

        function closeTryOnResult() {
            document.getElementById('tryOnResultModal').style.display = 'none';
        }

        function saveTryOnResult() {
            const resultImage = document.getElementById('tryOnResultImage');
            if (resultImage && resultImage.src) {
                const link = document.createElement('a');
                link.download = `virtual-tryon-result-${Date.now()}.jpg`;
                link.href = resultImage.src;
                link.click();
                showNotification('💾 Result saved!', 'success');
            }
        }

        function updateMultiplier(value) {
            document.getElementById('multiplierValue').textContent = `${value}x`;
            if (socket) {
                socket.emit('calibrate', { multiplier: parseFloat(value) });
            }
        }

        function resetCalibration() {
            document.getElementById('multiplierSlider').value = '1.0';
            document.getElementById('multiplierValue').textContent = '1.0x';
            if (socket) {
                socket.emit('calibrate', { preset: true });
            }
        }

        function toggleZInfo() {
            if (socket) {
                socket.emit('toggle_z_info');
            }
        }

        function openClothingCatalog() {
            window.open('catalog.html', '_blank');
        }

        function capturePhoto() {
            const video = document.getElementById('liveVideo');
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);
            
            const link = document.createElement('a');
            link.download = `capture-${Date.now()}.jpg`;
            link.href = canvas.toDataURL('image/jpeg');
            link.click();
            
            showNotification('📸 Photo captured!', 'success');
        }

        function downloadMeasurements() {
            const measurements = {
                timestamp: new Date().toISOString(),
                shoulder_cm: document.getElementById('shoulderMeasurement').textContent,
                waist_cm: document.getElementById('waistMeasurement').textContent,
                confidence: document.getElementById('confidenceLevel').textContent,
                resolution: document.getElementById('resolutionInfo').textContent
            };
            
            const blob = new Blob([JSON.stringify(measurements, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.download = `measurements-${Date.now()}.json`;
            link.href = URL.createObjectURL(blob);
            link.click();
            
            showNotification('💾 Measurements saved!', 'success');
        }

        // Camera mode result actions
        function saveCameraResult() {
            if (window.currentCameraResult) {
                const link = document.createElement('a');
                link.download = `virtual-tryon-${Date.now()}.jpg`;
                link.href = window.currentCameraResult;
                link.click();
                showNotification('💾 Try-on result saved!', 'success');
            }
        }

        function shareCameraResult() {
            if (window.currentCameraResult && navigator.share) {
                fetch(window.currentCameraResult)
                    .then(res => res.blob())
                    .then(blob => {
                        const file = new File([blob], 'virtual-tryon-result.jpg', { type: 'image/jpeg' });
                        navigator.share({
                            title: 'My Virtual Try-On Result',
                            text: 'Check out how this outfit looks on me!',
                            files: [file]
                        });
                    })
                    .catch(() => {
                        // Fallback: copy to clipboard
                        if (navigator.clipboard) {
                            navigator.clipboard.writeText(window.currentCameraResult);
                            showNotification('📋 Result copied to clipboard!', 'info');
                        }
                    });
            } else if (window.currentCameraResult && navigator.clipboard) {
                navigator.clipboard.writeText(window.currentCameraResult);
                showNotification('📋 Result copied to clipboard!', 'info');
            }
        }

        function tryAgain() {
            // Hide result display
            const cameraResultDisplay = document.getElementById('cameraResultDisplay');
            if (cameraResultDisplay) {
                cameraResultDisplay.style.display = 'none';
            }
            
            // Clear stored result
            window.currentCameraResult = null;
            
            showNotification('🎯 Ready for another try-on!', 'info');
        }

        function showNotification(message, type = 'info') {
            const notifications = document.getElementById('notifications');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            const icons = {
                success: '✅',
                error: '❌',
                warning: '⚠️',
                info: 'ℹ️'
            };
            
            notification.innerHTML = `${icons[type] || 'ℹ️'} ${message}`;
            notifications.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        // Debug functions
        function toggleDebug() {
            const debugPanel = document.getElementById('debugPanel');
            if (debugPanel.style.display === 'none') {
                debugPanel.style.display = 'block';
                updateDebugInfo();
            } else {
                debugPanel.style.display = 'none';
            }
        }

        function updateDebugInfo() {
            document.getElementById('debugCamera').textContent = mediaStream ? 'Running' : 'Stopped';
            document.getElementById('debugClothing').textContent = currentClothingFile ? currentClothingFile.name : 'Not selected';
            
            // Check API status
            fetch(`${API_BASE}/health`)
                .then(res => res.json())
                .then(data => {
                    document.getElementById('debugAPI').textContent = data.status || 'Unknown';
                })
                .catch(() => {
                    document.getElementById('debugAPI').textContent = 'Unavailable';
                });
        }

        async function testAPICall() {
            if (!currentClothingFile) {
                showNotification('❌ Need clothing file for test', 'error');
                return;
            }

            if (!mediaStream) {
                showNotification('❌ Need camera running for test', 'error');
                return;
            }

            try {
                showNotification('🧪 Testing API call...', 'info');
                
                const startTime = Date.now();
                const formData = new FormData();
                formData.append('clothing_image', currentClothingFile);
                
                console.log('🧪 Test API call starting...');
                
                const response = await fetch(`${API_BASE}/virtual-tryon`, {
                    method: 'POST',
                    body: formData
                });
                
                const endTime = Date.now();
                const duration = endTime - startTime;
                
                document.getElementById('debugLastCall').textContent = `${response.status} (${duration}ms)`;
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('🧪 Test result:', result);
                    
                    if (result.success) {
                        showNotification(`✅ API test successful (${duration}ms)`, 'success');
                        
                        // Show result in the main modal for consistency
                        showTryOnResult('data:image/jpeg;base64,' + result.result_image_base64);
                        
                        // Also show a popup with technical details
                        const popup = window.open('', '_blank', 'width=400,height=300');
                        popup.document.write(`
                            <html>
                                <head><title>API Test Result</title></head>
                                <body style="margin: 20px; text-align: center; font-family: Arial;">
                                    <h3>🧪 API Test Result</h3>
                                    <p><strong>Status:</strong> ✅ Success</p>
                                    <p><strong>Response time:</strong> ${duration}ms</p>
                                    <p><strong>Image size:</strong> ${result.result_image_base64.length} chars</p>
                                    <p>Result image displayed in main window.</p>
                                    <button onclick="window.close()" style="padding: 10px 20px; margin-top: 10px;">Close</button>
                                </body>
                            </html>
                        `);
                    } else {
                        showNotification(`❌ API test failed: ${result.error}`, 'error');
                    }
                } else {
                    const errorText = await response.text();
                    console.error('🧪 Test failed:', response.status, errorText);
                    showNotification(`❌ API test failed: ${response.status}`, 'error');
                }
                
            } catch (error) {
                console.error('🧪 Test error:', error);
                showNotification(`❌ Test error: ${error.message}`, 'error');
                                 document.getElementById('debugLastCall').textContent = `Error: ${error.message}`;
             }
         }

         // Simple API test without files
         async function simpleAPITest() {
             try {
                 showNotification('🔍 Testing basic API connectivity...', 'info');
                 
                 console.log('🔍 Testing /virtual-tryon endpoint...');
                 
                 // Try to call the endpoint without files to see basic connectivity
                 const response = await fetch(`${API_BASE}/virtual-tryon`, {
                     method: 'POST',
                     body: new FormData() // Empty form data
                 });
                 
                 console.log('Basic test response:', response.status, response.statusText);
                 
                 const responseText = await response.text();
                 console.log('Response text:', responseText);
                 
                 if (response.status === 400 && responseText.includes('No clothing image provided')) {
                     showNotification('✅ API endpoint is reachable and responding correctly', 'success');
                     document.getElementById('debugAPI').textContent = 'Reachable';
                 } else {
                     showNotification(`⚠️ Unexpected response: ${response.status}`, 'warning');
                 }
                 
             } catch (error) {
                 console.error('Basic API test failed:', error);
                 showNotification(`❌ API connection failed: ${error.message}`, 'error');
                 document.getElementById('debugAPI').textContent = 'Failed';
             }
         }
    </script>
</body>
</html> 